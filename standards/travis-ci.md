# Travis CI #

## What does Travis CI do? ##

### CI: Continuous Integration ###

From Travis CI documentation

> Continuous Integration is the practice of merging in small code changes frequently - rather than merging in a large change at the end of a development cycle. The goal is to build healthier software by developing and testing in smaller increments.

## Process ##

In NYPL Digital's CI/CD stack, when a pull request is merging with, e.g., `development` branch, a series of steps is taken to build, test, and deploy to the branch.  

**Travis CI** is a tool with options to deploy to our services of choice, e.g. AWS Elastic Beanstalk.

### .travis.yml ###

Travis CI looks for a configuration file named `.travis.yml` to receive instructions on how to build, test, and deploy an application. This means the following:

* The file MUST be located at the **root level** of the code repository, such as `NYPL/staff-picks/.travis.yml`.
* The file MUST be named `.travis.yml`, with a leading period in the file name.

### Build ###

A basic build on Travis CI consists of the following steps
1. `install`: installs required dependencies for the application
2. `script`: runs the build script(s) for the application

There are many steps in between the two configuration stages mentioned above that can be added for further customization. Here's a list of frequently used Travis CI configuration stages on NYPL applications, from top to bottom of `.travis.yml` file:

1. `language`: Programming language of the code repository
2. Language version such as `rvm`, `node_js`, etc.
3. `sudo` to indicate whether `sudo` privileges are required.
4. `before_install` to include any applications that are needed to build and/or test an application, but are not included as part of the standard virtualization machine generated by Travis.
4. `addons` is similar to `before_install`, for quick shortcuts if you already know which APT package you want to install
5. `cache` to cache content that does not often change, to speed up your build process, e.g. `node_modules` directory from node apps.
7. `install`: Same description as mentioned above.
8. `before_script`: Install dependencies required to build the application
9. `script`: Same description as mentioned above.
10. `before_deploy`: Used for user-friendly messages to notify user of deployment.
11. `deploy`: Sets up watched branches and AWS credentials needed to deploy to, e.g. Elastic Beanstalk
12. `after_deploy`: Used for user-friendly messages to notify user deployment is successfully triggered.

### Test ###
Testing is often run during the `script` configuration stage as part of the build.


### Deploy ###
Travis has a `deploy` configuration stage, with a list of preconfigured providers you can use for deployments.

To configure Travis to deploy to Elastic Beanstalk:

 1. If you haven't already, run log in to Github through travis:
    `travis login --org`
 2. Add encrypted credentials to `.travis.yml` by running this encrypted command (stored in nypl-digital-dev parameter store): https://console.aws.amazon.com/ec2/v2/home?region=us-east-1#Parameters:Name=%5BEquals%5Dproduction/travis/add_aws;sort=Name
 3. Add `deploy` entries to `.travis.yml` for each deploy hook, e.g.:
   ```
   deploy:
    - provider: elasticbeanstalk
      skip_cleanup: true
      access_key_id: "$AWS_ACCESS_KEY_ID_DEVELOPMENT"
      secret_access_key: "$AWS_SECRET_ACCESS_KEY_DEVELOPMENT"
      region: us-east-1
      app: discovery-api # This is the name of the app
      env: discovery-api-dev # This is the specific deployment
      bucket_name: elasticbeanstalk-us-east-1-224280085904 # This is common across EB deployments in a given account
      bucket_path: discovery-api-dev # Conventionally this should equal the `env` name
      on:
        repo: NYPL-discovery/discovery-api
        branch: development # This is the branch in origin we'll watch
   ```

## Troubleshooting

### Chrome
When using Chrome to conduct tests such as with `karma`, Chrome is not installed by default on the virtualization environment.

The idea is to install Chrome as an apt addon and enabling display within the Travis virtualization machine so Chrome can run with a monitor on the background.

```
addons:
  chrome: stable  # have Travis install chrome stable.
  ...
before_script:
  - export DISPLAY=:99.0  # Export display to Travis
  - sh -e /etc/init.d/xvfb start  # Start graphical operations
```

### Headless Chrome

The installation of Chrome would still be required even if chrome-headless is used by `karma` or other test suites.

## References ##
* [Travis CI: Core Concepts for Beginners](https://docs.travis-ci.com/user/for-beginners/)
* [Travis CI: Customizing the Build](https://docs.travis-ci.com/user/customizing-the-build/)
* [Chromedriver support](https://github.com/travis-ci/travis-ci/issues/272#issuecomment-14402117)
* [How to make travis execute Angular tests on Chrome](https://stackoverflow.com/questions/19255976/how-to-make-travis-execute-angular-tests-on-chrome-please-set-env-variable-chr)
